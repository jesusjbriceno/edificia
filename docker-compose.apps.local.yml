# ============================================================
# EDIFICIA — Docker Compose (Solo Apps — BD y Redis externos)
# Uso: docker compose -f docker-compose.apps.yml up -d
#
# Variables dinámicas (DB_HOST, JWT_SECRET, etc.) se inyectan:
#   • Desde un fichero .env en la raíz del repositorio, o
#   • Desde la UI de Coolify / Portainer.
#
# Program.cs mapea los nombres cortos (DB_HOST, JWT_SECRET…)
# a las claves de configuración de .NET automáticamente.
# Consulta .env.example para la lista completa.
# ============================================================

services:
  # ── Backend API ──
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    image: ghcr.io/jesusjbriceno/edificia-api:latest
    container_name: edificia_prod_api
    restart: always
    ports:
      - "5000:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    env_file:
      - path: .env
        required: false
    environment:
      ASPNETCORE_ENVIRONMENT: Local
      ASPNETCORE_URLS: "http://+:8080"
      # Fixed production values (secrets come from .env / Coolify UI)
      Jwt__Issuer: "http://localhost:5000"
      Jwt__Audience: "http://localhost:5000"
      Cors__AllowedOrigins__0: "http://localhost:4324"
      Cors__AllowedOrigins__1: "http://localhost:4321"

  # ── Frontend Web ──
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    image: ghcr.io/jesusjbriceno/edificia-web:latest
    container_name: edificia_prod_web
    restart: always
    ports:
      - "4324:4324"
    env_file:
      - path: .env
        required: false
    environment:
      PUBLIC_API_URL: "http://localhost:5000/api"
      HOST: "0.0.0.0"
      PORT: "4324"
    depends_on:
      - api
