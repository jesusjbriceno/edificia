# ============================================================
# EDIFICIA — Docker Compose (Solo Apps — BD y Redis externos)
# Uso: docker compose -f docker-compose.apps.yml up -d
#
# Variables dinámicas (DB_HOST, JWT_SECRET, etc.) se inyectan:
#   • Desde un fichero .env en la raíz del repositorio, o
#   • Desde la UI de Coolify / Portainer.
#
# Program.cs mapea los nombres cortos (DB_HOST, JWT_SECRET…)
# a las claves de configuración de .NET automáticamente.
# Consulta .env.example para la lista completa.
#
# NOTAS Coolify v4:
#   • Los puertos NO se exponen en el host; Traefik gestiona el routing HTTPS.
#   • Los labels de Traefik configuran las reglas de dominio y TLS.
#   • El healthcheck del web espera a que la API esté sana antes de arrancar.
# ============================================================

services:
  # ── Backend API ──
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    image: ghcr.io/jesusjbriceno/edificia-api:latest
    container_name: edificia_prod_api
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health/live"]
      interval: 30s
      timeout: 5s
      start_period: 60s
      retries: 5
    labels:
      - "coolify.managed=true"
      - "traefik.enable=true"
      - "traefik.http.routers.edificia-api.rule=Host(`api-edificia.jesusjbriceno.dev`)"
      - "traefik.http.routers.edificia-api.entryPoints=https"
      - "traefik.http.routers.edificia-api.tls=true"
      - "traefik.http.routers.edificia-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.edificia-api.loadbalancer.server.port=8080"
    networks:
      - coolify-network
    env_file:
      - path: .env
        required: false
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      # Fixed production values (secrets come from .env / Coolify UI)
      Jwt__Issuer: "https://api-edificia.jesusjbriceno.dev"
      Jwt__Audience: "https://edificia.jesusjbriceno.dev"
      Cors__AllowedOrigins__0: "https://edificia.jesusjbriceno.dev"

  # ── Frontend Web ──
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    image: ghcr.io/jesusjbriceno/edificia-web:latest
    container_name: edificia_prod_web
    restart: always
    # Sin healthcheck propio: el SSR de Astro puede fallar en arranque si la API
    # aún no está lista, lo que haría que Coolify marcase el contenedor como
    # "unhealthy" y Traefik dejase de enrutarle tráfico (sirve cert auto-firmado).
    exclude_from_hc: true
    env_file:
      - path: .env
        required: false
    environment:
      PUBLIC_API_URL: "https://api-edificia.jesusjbriceno.dev/api"  # Con /api — baseURL de Axios
      INTERNAL_API_URL: "http://api:8080"                           # Red interna Docker (SSR login proxy)
      HOST: "0.0.0.0"
      PORT: "4321"
    depends_on:
      api:
        condition: service_started
    labels:
      - "coolify.managed=true"
      - "traefik.enable=true"
      # Router HTTPS — sirve el tráfico con el cert Let's Encrypt
      - "traefik.http.routers.edificia-web.rule=Host(`edificia.jesusjbriceno.dev`)"
      - "traefik.http.routers.edificia-web.entryPoints=https"
      - "traefik.http.routers.edificia-web.tls=true"
      - "traefik.http.routers.edificia-web.tls.certresolver=letsencrypt"
      - "traefik.http.services.edificia-web.loadbalancer.server.port=4321"
      # Router HTTP — necesario para que Traefik resuelva el ACME HTTP-01 challenge
      # sin que el redirect global HTTP→HTTPS lo intercepte antes
      - "traefik.http.routers.edificia-web-http.rule=Host(`edificia.jesusjbriceno.dev`)"
      - "traefik.http.routers.edificia-web-http.entryPoints=http"
      - "traefik.http.routers.edificia-web-http.service=edificia-web"
    networks:
      - coolify-network

networks:
  coolify-network:
    external: true
    name: coolify
    