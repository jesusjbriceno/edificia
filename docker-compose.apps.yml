# ============================================================
# EDIFICIA — Docker Compose (Solo Apps — BD y Redis externos)
# Uso: docker compose -f docker-compose.apps.yml up -d
#
# Variables dinámicas (DB_HOST, JWT_SECRET, etc.) se inyectan:
#   • Desde un fichero .env en la raíz del repositorio, o
#   • Desde la UI de Coolify / Portainer.
#
# Program.cs mapea los nombres cortos (DB_HOST, JWT_SECRET…)
# a las claves de configuración de .NET automáticamente.
# Consulta .env.example para la lista completa.
#
# NOTAS Coolify v4:
#   • El routing HTTPS y los certificados Let's Encrypt los genera Coolify
#     automáticamente desde los dominios configurados en la UI.
#   • NO definir labels traefik.http.routers manualmente — Coolify los inyecta
#     usando el patrón http-0-UUID-service / https-0-UUID-service.
#   • Exponer los puertos internos para que Coolify sepa dónde dirigir el tráfico.
# ============================================================

services:
  # ── Backend API ──
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    image: ghcr.io/jesusjbriceno/edificia-api:latest
    container_name: edificia_prod_api
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health/live"]
      interval: 30s
      timeout: 5s
      start_period: 60s
      retries: 5
    ports:
      - "8080"
    labels:
      - "coolify.managed=true"
    networks:
      - coolify-network
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      # ── Base de datos ──
      DATABASE_URL: ${DATABASE_URL:-}
      DB_HOST: ${DB_HOST:-}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-edificia_db}
      DB_USER: ${DB_USER:-edificia}
      DB_PASSWORD: ${DB_PASSWORD:-}
      # ── JWT ──
      JWT_SECRET: ${JWT_SECRET:-}
      Jwt__Issuer: "https://api-edificia.jesusjbriceno.dev"
      Jwt__Audience: "https://edificia.jesusjbriceno.dev"
      # ── CORS ──
      Cors__AllowedOrigins__0: "https://edificia.jesusjbriceno.dev"
      # ── IA (n8n) ──
      N8N_WEBHOOK_URL: ${N8N_WEBHOOK_URL:-}
      N8N_API_SECRET: ${N8N_API_SECRET:-}
      N8N_TIMEOUT: ${N8N_TIMEOUT:-120}
      # ── Email ──
      EMAIL_PROVIDER: ${EMAIL_PROVIDER:-}
      EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS:-}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME:-}
      BREVO_API_KEY: ${BREVO_API_KEY:-}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_USE_SSL: ${SMTP_USE_SSL:-true}
      # ── Root Admin (seed inicial) ──
      ROOT_EMAIL: ${ROOT_EMAIL:-}
      ROOT_PASSWORD: ${ROOT_PASSWORD:-}

  # ── Frontend Web ──
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    image: ghcr.io/jesusjbriceno/edificia-web:latest
    container_name: edificia_prod_web
    restart: always
    exclude_from_hc: true
    environment:
      PUBLIC_API_URL: "https://api-edificia.jesusjbriceno.dev/api"
      INTERNAL_API_URL: "http://api:8080"
      NODE_ENV: "production"
      HOST: "0.0.0.0"
      PORT: "4321"
    ports:
      - "4321"
    depends_on:
      api:
        condition: service_started
    labels:
      - "coolify.managed=true"
    networks:
      - coolify-network

networks:
  coolify-network:
    external: true
    name: coolify
    